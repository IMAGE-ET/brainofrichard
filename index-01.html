<!doctype html>
<html lang="en">
<head>
<title>brain of richard</title>
<meta charset="utf-8">

<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<script src='http://mrdoob.github.com/three.js/build/three.min.js'></script>
<script src='http://mrdoob.github.com/three.js/examples/js/Stats.js'></script>
<script src="http://mrdoob.github.com/three.js/examples/js/Detector.js"></script>
<script src="http://dat-gui.googlecode.com/git/build/dat.gui.min.js"></script>
<!--
<script src='../../three.js/build/three.min.js'></script>
<script src='../../three.js/examples/js/Detector.js'></script>
<script src='../../three.js/examples/js/Stats.js'></script>
<script src='../../examples/js/DAT.GUI.min.js'></script>
-->
</head>
<body>
<script>
	if ( ! Detector.webgl ) { Detector.addGetWebGLMessage(); }

	document.body.style.font = '12pt monospace';
	document.body.style.margin = '0';
	document.body.style.overflow = 'hidden';
	document.body.style.textAlign = 'center';

	var info = document.createElement( 'div' );
	document.body.appendChild( info );
	info.style.top = '10px';
	info.style.color = '#000';
	info.style.position = 'absolute';
	info.style.width = '100%';
	info.innerHTML = 'brain of richard ross 2012-01-18' +
	' ~ <a id="h1" href="JavaScript:brainHack(1);">Hack01<\/a>' +
	' ~ <a id="h2" href="JavaScript:brainHack(2);">Hack02<\/a>' +
	' ~ <a id="h3" href="JavaScript:brainHack(3);">Hack03<\/a>' +
	' ~ <a id="c1" href="JavaScript:camera.up.set(0,1,0);controls.target.set(0,0,0);camera.position.set(200, 100, 250);">Home<\/a>' +
	' ~ <a id="c2" href="JavaScript:controls.target.set(0,0,0);camera.position.set(0, 200, 0);">Top<\/a>' +
	' ~ <a id="c3" href="JavaScript:controls.target.set(0,0,0);camera.position.set(200, 0, 0);">Side<\/a>' +
	'<br><a href="#" onClick="showSplash();">About<\/a>';

	var replay_is_on = false;
	var replayCharOn = "&#9658;";
	var replayCharOff = "&#9632;";
	var replayChar = replayCharOn;

	var splash = document.createElement( 'div' );
	document.body.appendChild( splash );
	splash.style.backgroundColor = '#ddd';
	splash.style.borderRadius = '10px';
	splash.style.boxShadow = '10px 10px 5px #888888';
	splash.style.color = '#000';
	splash.style.left = '10%';
	splash.style.opacity = '0.85';
	splash.style.padding = '15px';
	splash.style.position = 'absolute';
	splash.style.top = '10%';
	splash.style.width = '300px';
	var splashText = '<h2 style="text-align:right;"><a href="#" onClick="hideSplash()" style="color:#888;text-decoration:none;">[X]<\/a><\/h2>' +
	'<h1>The Brain of Richard App<\/h1><p>3D compilations of hundreds of 2D scanned MRI images.<\/p><h2>~<\/h2>' +
	'<p>To launch the demo,<\/p><p>click this play button: <\/p>';
	// splash.innerHTML = splashText + '<h1><a href="#" id="replay" onClick="playSound();" style="text-decoration:none;">' + replayChar + '<\/h1>';
	
	splash.innerHTML = splashText;
	
	var audioElement = document.createElement('audio');
	var whichApp = function(){};
	
	splash.appendChild( audioElement );
	audioElement.setAttribute('src', 'foreverautumn.mp3');
	audioElement.controls = 'true';
	
	audioElement.addEventListener("timeupdate", function() {
// console.log('time', whichApp);
		var duration = document.getElementById('duration');
		var s = parseInt(audioElement.currentTime % 60);
		var m = parseInt((audioElement.currentTime / 60) % 60);
		duration.innerHTML = m + ':' + s + 'sec ' + audioElement.currentTime + ' ' + audioElement.duration;
		if (audioElement.currentTime < 15) {
			whichApp = myDemo.theo;
		} 
		/*
		else if (audioElement.currentTime < 10) {
			whichApp = myDemo.fun2();
		} else if (audioElement.currentTime < 15) {
			whichApp = myDemo.fun3();
		} else if (audioElement.currentTime < 20) {
			whichApp = myDemo.fun2();
		} else {
			whichApp = myDemo.fun1();
		}
		*/
	}, false);
	
	audioElement.addEventListener("playing", function() {
		playingDemo = true;
// console.log('playing', playingDemo, audioElement.paused, audioElement.currentTime, new Date());
	}, false);
	
	audioElement.addEventListener("click", function() {
		if ( playingDemo ) {playingDemo = false;}
// console.log('click', playingDemo, audioElement.currentTime, audioElement.paused, new Date());
	}, false);
	
	var updates = document.createElement( 'div' );
	splash.appendChild( updates );
	updates.innerHTML = '<p id="duration">duration<\/p><p id="status">status<\/p>';

	var playingDemo = false;

    var scene, camera, controls, light, stats, renderer;
    var geometry, map, material, mesh;

	var clock = new THREE.Clock();
	var projector;
	var intersected;
	var mouseMove;

	var scans;
	var scanCurrent;
	var plane, boundary, axis, box;
	var gui;
	var objConfig = {
		highlighting: true,
		opacityDefault: 0.02,
		opacityHighlight: 0.8,
		scansStart: 1,
		scansFinish: 10,
		cameraMoving: true,
		cameraCutoffNear: 1,
		cameraCutoffFar: 500,
		planeVisible: false,
		boundaryVisible: false,
		axisVisible: false,
		boxVisible: false,
		boxX: 0,
		boxY: 0,
		boxZ: 0,
		boxScaleX: 0,
		boxScaleY: 0,
		boxScaleZ: 0,
	};
	var hack = {};


	function brainHack(count) {
		if (count === 1) {
			hack = {
				count: 26,
				dir: 'hack01/',
				angle: 1.5708,
				startY: -50,
				startZ: 0,
				deltaY: 5,
				deltaZ: 0,
				opacityDefault: 0.2,
				meshY: -50
			};
		}
		if (count === 2) {
			hack = {
				count: 91,
				dir: 'hack02/',
				angle: 0,
				startY: 0,
				startZ: 0,
				deltaY: 0,
				deltaZ: -1,
				opacityDefault: 0.02,
				meshY: -100
			};
		}
		if (count === 3) {
			hack = {
				count: 123,
				dir: 'hack03/',
				angle: 0,
				startY: 0,
				startZ: 0,
				deltaY: 0,
				deltaZ: -1,
				opacityDefault: 0.02,
				meshY: -100
			};
		}
		objConfig.opacityDefault = hack.opacityDefault;
		objConfig.scansFinish = hack.count;
		buildBrain();
		buildGui();
	}

	init();
    animate();
	brainHack(1);

    function init() {
        renderer = new THREE.WebGLRenderer( {antialias: true } );
        renderer.setSize( window.innerWidth, window.innerHeight );
        document.body.appendChild( renderer.domElement );

        scene = new THREE.Scene();

        camera = new THREE.PerspectiveCamera( 40, window.innerWidth / window.innerHeight, 10, 10000 );
        camera.position.set(200, 100, 250);
        scene.add( camera );

		controls = new THREE.TrackballControls( camera );
		controls.maxDistance = 800;

		stats = new Stats();
		stats.domElement.style.position = 'absolute';
		stats.domElement.style.top = '0px';
		stats.domElement.style.zIndex = 100;
		document.body.appendChild( stats.domElement );

		projector = new THREE.Projector();

		document.addEventListener( 'mousemove', onDocumentMouseMove, false );
		document.addEventListener( 'click', onDocumentMouseClick, false ); // or mousedown?
		document.addEventListener( 'keydown', onKeyDown, false );
    }

    function animate() {
        requestAnimationFrame( animate );
        render();
		stats.update();
    }

    function render() {
		controls.update( clock.getDelta() );
        renderer.render( scene, camera );

		var tim = clock.elapsedTime;
		if (!mouseMove && !playingDemo && objConfig.cameraMoving) {
			camera.position.x += -1 * Math.cos( tim * 0.15);
			camera.position.z += -1 * Math.sin( tim * 0.15);
		} else if ( playingDemo) {
			whichApp();
			// console.log('render', whichApp());
		}	
		mouseMove = false;
		
    }

	function buildBrain() {
		if (scans) { scene.remove(scans); }

		geometry = new THREE.PlaneGeometry( 200, 200, 10, 10 );
		scans = new THREE.Object3D();
		var i;
		for (var i = 1; i <= hack.count; i++) {
			map = THREE.ImageUtils.loadTexture( hack.dir + i + '.png' );
			material = new THREE.MeshBasicMaterial( { color: 0xffffff, ambient: 0xffffffff, map: map, opacity: hack.opacityDefault, side: THREE.DoubleSide, transparent: true, wireframe: false} );
			mesh = new THREE.Mesh( geometry, material );
			mesh.rotation.x = hack.angle;
			mesh.position.set(0, hack.startY + i * hack.deltaY, hack.startZ + i * hack.deltaZ);
			scans.add( mesh );
		}
		scene.add( scans );
	}

	function buildGui() {
		if (gui) {
		  gui.destroy();
		  gui = null;
		}

		gui = new dat.GUI( { height: 14 * 32 - 1});
		
		gui.add( objConfig, 'highlighting', true ).onChange( function() {
			if ( !objConfig.highlighting) {
				objConfig.highlighting = false;
			} else {
				objConfig.highlighting = true;
			}
		} );		

		gui.add( objConfig, 'opacityDefault', 0.01, 1 ).step(0.01).onChange( function() {
			for (var i = 0, l = scans.length; i < l; i++) {
				scans[i].material.opacity = ( objConfig.opacityDefault );
			}
		} );

		gui.add( objConfig, 'opacityHighlight').min(0.01).max(1).step(0.01).onChange( function() {
		} );

		gui.add( objConfig, 'scansStart').min(1).max(hack.count).step(1).onChange( function() {
			for (var i = 0, l = hack.count; i < l; i++) {
				if (i < objConfig.scansStart || i > objConfig.scansFinish) {scans.children[i].visible = false;
				} else {
					scans.children[i].visible = true;
				}
			}
		} );

		gui.add( objConfig, 'scansFinish').min(1).max(hack.count).step(1).onChange( function() {
			for (var i = 0, l = hack.count; i < l; i++) {
				if (i < objConfig.scansStart || i > objConfig.scansFinish) {scans.children[i].visible = false;
				} else {
					scans.children[i].visible = true;
				}
			}
		} );

		gui.add( objConfig, 'cameraMoving', true ).onChange( function() {
			if ( !objConfig.cameraMoving) {
				objConfig.cameraMoving = false;
			} else {
				objConfig.cameraMoving = true;
			}
		} );
		
		gui.add( objConfig, 'cameraCutoffNear', 1, 500 ).onChange( function() {
			camera.near = objConfig.cameraCutoffNear;
			camera.updateProjectionMatrix();
		} );

		gui.add( objConfig, 'cameraCutoffFar', 1, 500 ).onChange( function() {
			camera.far = objConfig.cameraCutoffFar;
			camera.updateProjectionMatrix();
		} );

		var guiBox = gui.addFolder('Extras');

		guiBox.add( objConfig, 'planeVisible', true ).onChange( function() {
			if ( !objConfig.planeVisible) {
				objConfig.planeVisible = false;
				scene.remove( plane );
			} else {
				objConfig.planeVisible = true;
				if (plane) { scene.remove(plane); }
				geometry = new THREE.CubeGeometry( 500, 0.1, 500, 10, 10, 10);
				material = new THREE.MeshNormalMaterial( { wireframe: true } );
				plane = new THREE.Mesh( geometry, material );
				plane.position.set(0, hack.meshY, 0);
				scene.add( plane );
			}
		} );

		guiBox.add( objConfig, 'boundaryVisible', true ).onChange( function() {
			if ( !objConfig.boundaryVisible) {
				objConfig.boundaryVisible = false;
				scene.remove( boundary );
			} else {
				objConfig.boundaryVisible = true;
				if (boundary) { scene.remove(boundary); }
				geometry = new THREE.CubeGeometry( 200, hack.deltaY * hack.count, 200, 1, 1, 1);
				material = new THREE.MeshNormalMaterial( { wireframe: true } );
				boundary = new THREE.Mesh( geometry, material );
				boundary.rotation.x = hack.angle;
				boundary.position.set(0, hack.startY + 0.5 * hack.count * hack.deltaY, hack.startZ + 0.5 * hack.count * hack.deltaZ);
				scene.add( boundary );
			}
		} );

		guiBox.add( objConfig, 'axisVisible', true ).onChange( function() {
			if ( !objConfig.axisVisible) {
				objConfig.axisVisible = false;
				scene.remove( axis );
			} else {
				objConfig.axisVisible = true;
				axis = new THREE.AxisHelper();
				axis.position.set( 0, 0, 0 );
				axis.scale.x = axis.scale.y = axis.scale.z = 0.5;
				scene.add( axis );
			}
		} );

		guiBox.add( objConfig, 'boxVisible', true ).onChange( function() {
			if ( !objConfig.boxVisible) {
				objConfig.boxVisible = false;
				scene.remove( box );
			} else {
				objConfig.boxVisible = true;
				geometry = new THREE.CubeGeometry( 20, 20, 20);
				material = new THREE.MeshNormalMaterial( { wireframe: true } );
				box = new THREE.Mesh( geometry, material );
				box.position.set(0, 0, 0);
				scene.add( box );
			}
		} );
		guiBox.add( objConfig, 'boxX', -100, 100 ).onChange( function() {
			if (box) { box.position.x = objConfig.boxX; }
		} );
		guiBox.add( objConfig, 'boxY', -100, 100 ).onChange( function() {
			if (box) { box.position.y = objConfig.boxY; }
		} );
		guiBox.add( objConfig, 'boxZ', -100, 100 ).onChange( function() {
			if (box) { box.position.z = objConfig.boxZ; }
		} );


		guiBox.add( objConfig, 'boxScaleX', 0, 5 ).onChange( function() {
			if (box) { box.scale.x = objConfig.boxScaleX; }
		} );
		guiBox.add( objConfig, 'boxScaleY', 0, 5 ).onChange( function() {
			if (box) { box.scale.y = objConfig.boxScaleY; }
		} );
		guiBox.add( objConfig, 'boxScaleZ', 0, 5 ).onChange( function() {
			if (box) { box.scale.z = objConfig.boxScaleZ; }
		} );

		guiBox.close();
	}

	function onDocumentMouseMove( event ) { // needs work - see also above
		var vector = new THREE.Vector3( ( event.clientX / window.innerWidth ) * 2 - 1, - ( event.clientY / window.innerHeight ) * 2 + 1, 0.5 );
		projector.unprojectVector( vector, camera );
		var ray = new THREE.Ray( camera.position, vector.subSelf( camera.position ).normalize() );
		var intersects = ray.intersectObjects( scans.children );
		if ( intersects.length > 0 ) {
			if ( objConfig.highlighting && intersected !== intersects[ 0 ].object ) {
				if ( intersected ) { intersected.material.opacity = objConfig.opacityDefault; }
				intersected = intersects[ 0 ].object;
				scanCurrent = scans.children.indexOf(intersected);
				scanHighlight(scanCurrent);
			}
		} else {
			if (intersected) { intersected.material.opacity = objConfig.opacityDefault; }
			intersected = null;
		}
		mouseMove = true;
	}

	function onDocumentMouseClick( event ) {
		// splash.style.display = 'none';
	}

	function onKeyDown ( event ) {
// http://www.webonweboff.com/tips/js/event_key_codes.aspx
		switch( event.keyCode ) {
			case 37: /*<*/	scanCurrent--; if (scanCurrent < 0) {scanCurrent = hack.count;} scanHighlight(scanCurrent); break;
			case 39: /*>*/	scanCurrent++; if (scanCurrent > hack.count) {scanCurrent = 0;} scanHighlight(scanCurrent); break;
			case 38: /*^*/	scanCurrent = 0; scanHighlight(0); break;
			case 40: /*v*/	scanCurrent = hack.count; scanHighlight(hack.count - 1); break;
		}
	}

	function scanHighlight(count) {
		for (var i = objConfig.scansStart - 1, l = hack.count; i < l; i++) {
			scans.children[i].material.opacity = objConfig.opacityDefault;
			if (i === count) { scans.children[i].material.opacity = objConfig.opacityHighlight; }
			// if (var i == count + 1 && scans.children[i + 1]) scans.children[i].material.opacity = objConfig.opacityHighlight - 0.5;
			// if (var i == count - 1 && scans.children[i - 1]) scans.children[i].material.opacity = objConfig.opacityHighlight - 0.5;
		}
	}

	function hideSplash() {
		splash.style.display = 'none';
		replay_is_on = false;
		audioElement.pause();
	}

	function showSplash() {
		splash.style.display = 'block';
	}
	
/*	
	audioElement.addEventListener("timeupdate", function() {
	console.log(audioElement.currentTime);
		var duration = document.getElementById('duration');
		var s = parseInt(audioElement.currentTime % 60);
		var m = parseInt((audioElement.currentTime / 60) % 60);
		duration.innerHTML = m + ':' + s + 'sec ' + audioElement.currentTime + ' ' + audioElement.duration;
		if (audioElement.currentTime < 15) {
			whichApp = myDemo.theo();
		} 
		/*
		else if (audioElement.currentTime < 10) {
			whichApp = myDemo.fun2();
		} else if (audioElement.currentTime < 15) {
			whichApp = myDemo.fun3();
		} else if (audioElement.currentTime < 20) {
			whichApp = myDemo.fun2();
		} else {
			whichApp = myDemo.fun1();
		}
		
	}, false);
	
*/
	
	var myDemo = myDemo || {};
	
	myDemo.i = 20;
	myDemo.object = '';
	myDemo.currentApp = '';
	
	myDemo.theo = function() {
		if ( myDemo.currentApp != 'theo' ) {
			myDemo.i = 20;
			myDemo.currentApp = 'theo';
			myDemo.object = document.createElement( 'div' );
			document.body.appendChild( myDemo.object );
			myDemo.object.style.top = '20%';
			myDemo.object.style.position = 'absolute';
			myDemo.object.innerHTML = '<img src="theo-logo.png" width=200>';
		}
		var stats = document.getElementById('status');
		stats.innerHTML='1. Hello world! ~ ' + new Date();
		//splash.style.left = 200 + MyLib.i + 'px';
		// if (MyLib.i > 80) { MyLib.i = 10; }
		myDemo.i++;
		
		//x += deltaX;
		//y += deltaY;
		myDemo.object.style.left = 5 * myDemo.i + 'px';
		myDemo.object.style.top = myDemo.i + 'px';
		if (myDemo.i > window.innerHeight - 100 ) {myDemo.i = 20;}
		//if (y < 100) {deltaY = -deltaY;}
		//if (y > window.innerHeight) {deltaY = -deltaY;}
		//i++;
	}
	
	/*
	function playSound() {
		if (replay_is_on) {
			replay_is_on = true;
			replayChar = replayCharOn;
			if (!audioElement.src) { audioElement.setAttribute('src', 'vid1.wav'); }
			audioElement.play();
		} else {
			replay_is_on = false;
			replayChar = replayCharOff;
			audioElement.pause();
		}
		splash.innerHTML = splashText + '<h1><a href="#" id="replay" onClick="playSound();" style="text-decoration:none;">' + replayChar + '<\/h1>';
		playDemo();
	}

	
	function playDemo() {
		
		controls.target.set( 0, 0, 0);
		camera.up.set(0, 1, 0);
		camera.position.set(200, 100, 250);
		
		// playingDemo = true;
		showTheo();
		// showImages();
		// demoRotate(1, 0.05);
		// highlightID(1,'h1');
	}
	
	
	
	var t, images;

	function showTheo() {
		var theo = document.createElement( 'div' );
		document.body.appendChild( theo );
		theo.style.top = '20%';
		theo.style.position = 'absolute';
		theo.innerHTML = '<img src="theo-logo.png" width=200>';
		moveTheo( 1, theo, 800, 2, 200, -2);
	}

	function moveTheo(i, theo, x, deltaX, y, deltaY) {
		x += deltaX;
		y += deltaY;
		theo.style.left = x + 'px';
		theo.style.top = y + 'px';
		if (x > window.innerWidth - 100 || x < 100) {deltaX = -deltaX;}
		if (y < 100) {deltaY = -deltaY;}
		if (y > window.innerHeight) {deltaY = -deltaY;}
		i++;
		if (i < 1000) { t=setTimeout( function() { moveTheo(i, theo, x, deltaX, y, deltaY); }, 5 );
		} else {
			clearTimeout(t);
			theo.style.display = 'none';
			showImages();
		}
	}
*/

	function showImages() {
		if (images) { scene.remove(images); }

		geometry = new THREE.CubeGeometry( 100, 100, 100 );
		images = new THREE.Object3D();
		for (var i = 1; i <= hack.count; i++) {
			map = THREE.ImageUtils.loadTexture( hack.dir + i + '.png' );
			material = new THREE.MeshBasicMaterial( { color: 0xffffff, ambient: 0xffffffff, map: map, opacity: 1, side: THREE.DoubleSide, transparent: true, wireframe: false} );
			mesh = new THREE.Mesh( geometry, material );
			// mesh.scale.set(0.01, 0.01, 0.01);
			mesh.rotation.set(1.57 * Math.random(), 1.57 * Math.random(), 1.57 * Math.random());
			mesh.position.set(200 * Math.random() - 100, 200 * Math.random() + hack.startY - 50, 200 * Math.random() - 100 );
			images.add( mesh );
		}
		scene.add( images );

		moveImages(1, 0.01);
		// demoRotate(1, 0.05);
	}

	function moveImages(count, delta) {
		for (var i = 0, l = hack.count; i < l; i++) {
			scans.children[i].visible = false;
		}

		images.scale.set( 0.01 * count, 0.01 * count, 0.01 * count);

		delta += delta;
		images.rotation.set( delta, delta, delta);
		count++;
		// if (i % 10) { delta = -delta;}
		if (count < 100) {
			t=setTimeout(function(){moveImages(count, delta); },200);
		} else {
			clearTimeout(t);
			scene.remove( images );
			demoRotate(1, 0.05);
		}
	}

	function demoRotate(count, delta) {
		for (var i = 0, l = hack.count; i < l; i++) {
			scans.children[i].visible = true;
		}
		scans.rotation.y += delta;
		count++;
		if (count === 50) { delta = -delta;}
		if (count < 100) {
			t=setTimeout(function(){demoRotate(count, delta); },20);
		} else {
			clearTimeout(t);
			callbackRotate();
		}
	}

	function callbackRotate() {
		demoZoom(1,1,0.05);
	}

	function demoZoom(i,scl,delta) {
		scl += delta;
		scans.scale.set(scl,scl,scl);
		i++;
		if (i === 50) { delta = -delta; }
		if (i < 100) {
			t=setTimeout( function(){ demoZoom( i, scl, delta); } , 20 );
		} else {
			clearTimeout(t);
			callbackZoom();
		}
	}

	function callbackZoom() {
		demoMove(1, 2);
	}

	function demoMove(i,delta) {
		scans.position.z += delta;
		i++;
		if (i === 50) { delta = -delta;}
		if (i < 100) {
			t=setTimeout( function(){ demoMove(i,delta ); },20);
		} else {
			clearTimeout(t);
			callbackMove();
		}
	}

	function callbackMove() {
		highlightID(1,'h1', '#cc0000');
	}

	function highlightID(i,id, colr) {
		var thing = document.getElementById(id);
		if (i % 2) {
			thing.style.backgroundColor = colr;
		} else {
			thing.style.backgroundColor = '#ffffff';
		}
		i++;
		// if (i == 50) { delta = -delta;}
		if (i < 10) {
			t=setTimeout(function(){highlightID(i,id, colr); },200);
		} else {
			clearTimeout(t);
			thing.style.backgroundColor = '#ffffff';
			callbackHighLightID(id);
		}
	}

	function callbackHighLightID(id) {
		ids = ['h1','h2','h3','c1','c2','c3'];
		i = ids.indexOf(id) + 1;
		if (i < 3) {colr = '#cc0000';} else { colr = '#00cc00';}
		if (i > ids.length - 1) {return;}
		highlightID(1,ids[i], colr);
	}

	function pauseComputer(ms) {
		ms += new Date().getTime();
		while ( new Date() < ms){}
	}
</script>
</body>
</html>