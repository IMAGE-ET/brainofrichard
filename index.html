<!doctype html>
<html lang="en">
<head>
<title>brain of richard</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<script src='http://mrdoob.github.com/three.js/build/three.min.js'></script>
<script src='http://mrdoob.github.com/three.js/examples/js/Stats.js'></script>
<script src="http://mrdoob.github.com/three.js/examples/js/Detector.js"></script>
<script src="http://dat-gui.googlecode.com/git/build/dat.gui.min.js"></script>
<!--
<script src='../../three.js/build/three.min.js'></script>
<script src='../../three.js/examples/js/Detector.js'></script>
<script src='../../three.js/examples/js/Stats.js'></script>
<script src='../../examples/js/DAT.GUI.min.js'></script>
-->

<script src="dat.gui.config.js"></script>
</head>
<body>
<script>
	if ( ! Detector.webgl ) { Detector.addGetWebGLMessage(); }

	document.body.style.font = '12pt monospace';
	document.body.style.margin = '0';
	document.body.style.overflow = 'hidden';
	document.body.style.textAlign = 'center';

	var info = document.createElement( 'div' );
	document.body.appendChild( info );
	info.style.top = '15px';
	info.style.color = '#000';
	info.style.position = 'absolute';
	info.style.width = '100%';
	info.innerHTML = '<b>brain of richard ~ 2012-01-18<\/b>';

	var splash = document.createElement( 'div' );
	document.body.appendChild( splash );
	splash.style.backgroundColor = '#ddd';
	splash.style.borderRadius = '10px';
	splash.style.boxShadow = '10px 10px 5px #888888';
	splash.style.color = '#000';
	splash.style.left = '80px';
	splash.style.opacity = '0.85';
	splash.style.padding = '15px';
	splash.style.position = 'absolute';
	splash.style.top = '48px';
	splash.style.width = '300px';
	var splashText = '<h2 style="text-align:right;"><a href="#" title="Click to close" onClick="brainDemo.hideSplash()" style="color:#888;text-decoration:none;">[X]<\/a><\/h2>' +
	'<h1>The Brain of Richard App<\/h1>' +
	'<p>3D compilations of hundreds of 2D scanned MRI images<\/p>' +
	'<p>Built by Richard and Theo<\/p>' +
	'<h2>~<\/h2>' +
	'<p>Launch the demo...<\/p>';
	splash.innerHTML = splashText;

	var audioElement = document.createElement('audio');
	splash.appendChild( audioElement );
	audioElement.setAttribute('src', 'brainOfRichard.ogg');
	audioElement.controls = 'true';

	var playingDemo = false;
	var whichApp = function(){ return;};

	audioElement.addEventListener("click", function() {
		if ( playingDemo ) {playingDemo = false;}
	}, false);

	audioElement.addEventListener("playing", function() {
		playingDemo = true;
	}, false);

	audioElement.addEventListener("timeupdate", function() {
		var duration = document.getElementById('duration'),
			s = parseInt(audioElement.currentTime % 60, 10),
			m = parseInt((audioElement.currentTime / 60) % 60, 10);
		if (audioElement.currentTime < 5) {
			whichApp = brainDemo.splashBrain;
		} else if (audioElement.currentTime < 9 ) {
			whichApp = brainDemo.theo;
		} else if (audioElement.currentTime < 14 ) {
			whichApp = brainDemo.richard;
		} else if (audioElement.currentTime < 28 ) {
			whichApp = brainDemo.showScans;
		} else if (audioElement.currentTime < 35 ) {
			whichApp = brainDemo.rotateBrain;
		} else if (audioElement.currentTime < 38 ) {
			whichApp = brainDemo.zoomBrain;
		} else if (audioElement.currentTime < 41 ) {
			whichApp = brainDemo.panBrain;
		} else if (audioElement.currentTime < 43 ) {
			whichApp = brainDemo.highlightId(0, '#ff0');

		} else if (audioElement.currentTime < 47 ) {
			whichApp = brainDemo.highlightId(1, '#ff0');

		} else if (audioElement.currentTime <  50 ) {
			brainHack(2);

		} else if (audioElement.currentTime < 54 ) {
			whichApp = brainDemo.highlightId(2, '#ff0');

		} else if (audioElement.currentTime < 72 ) {
			whichApp = brainDemo.highlightId(3, '#0ff');
		} else if (audioElement.currentTime < 74 ) {
			whichApp = brainDemo.highlightId(4, '#0ff');
		} else if (audioElement.currentTime < 76 ) {
			whichApp = brainDemo.highlightId(5, '#0ff');
		} else {
			whichApp = brainDemo.finish;
		}
	}, false);

	var updates = document.createElement( 'div' );
	splash.appendChild( updates );
	updates.innerHTML = '<p id="duration"><\/p><p id="status"><\/p>';

	var scene, camera, controls, light, stats, renderer;
	var geometry, map, material, mesh;

	var clock = new THREE.Clock();
	var projector;
	var intersected;
	var mouseMove;

	var scans;
	var plane, boundary, axis, box;

	var hack = {};

	function brainHack(count) {
		if (count === 1) {
			hack = {
				count: 26,
				dir: 'hack01/',
				angle: 1.5708,
				startY: -50,
				startZ: 0,
				deltaY: 5,
				deltaZ: 0,
				opacityDefault: 0.2,
				meshY: -50
			};
		}
		if (count === 2) {
			hack = {
				count: 91,
				dir: 'hack02/',
				angle: 0,
				startY: 0,
				startZ: 0,
				deltaY: 0,
				deltaZ: -1,
				opacityDefault: 0.02,
				meshY: -100
			};
		}
		if (count === 3) {
			hack = {
				count: 123,
				dir: 'hack03/',
				angle: 0,
				startY: 0,
				startZ: 0,
				deltaY: 0,
				deltaZ: -1,
				opacityDefault: 0.02,
				meshY: -100
			};
		}
		if ( count > 1 ) {
			guiConfig.cameraMoving = false;
			guiConfig.highlighting = false;
		}
		guiConfig.opacityDefault = hack.opacityDefault;
		guiConfig.scansFinish = hack.count;
		brainApp.buildBrain();
		buildGui();
	}

	var brainApp = brainApp || {};

	brainApp.buildBrain = function() {
		if ( scans ) { scene.remove(scans); }
		geometry = new THREE.PlaneGeometry( 200, 200, 10, 10 );
		scans = new THREE.Object3D();
		scans.current = 0;
		var i, l = hack.count;
		for (i = 1; i <= l; i++) {
			map = THREE.ImageUtils.loadTexture( hack.dir + i + '.png' );
			material = new THREE.MeshBasicMaterial( { color: 0xffffff, ambient: 0xffffffff, map: map, opacity: hack.opacityDefault, side: THREE.DoubleSide, transparent: true, wireframe: false} );
			mesh = new THREE.Mesh( geometry, material );
			mesh.rotation.x = hack.angle;
			mesh.position.set(0, hack.startY + i * hack.deltaY, hack.startZ + i * hack.deltaZ);
			scans.add( mesh );
		}
		scene.add( scans );
	};

	brainApp.scanHighlight = function(count) {
		var i;
		for (i = guiConfig.scansStart - 1, l = hack.count; i < l; i++) {
			scans.children[i].material.opacity = guiConfig.opacityDefault;
			if (i === count) { scans.children[i].material.opacity = guiConfig.opacityHighlight; }
		}
	};

	init();
	brainHack(1);
	animate();

    function init() {

        renderer = new THREE.WebGLRenderer( {antialias: true } );
        renderer.setSize( window.innerWidth, window.innerHeight );
        document.body.appendChild( renderer.domElement );

        scene = new THREE.Scene();

        camera = new THREE.PerspectiveCamera( 40, window.innerWidth / window.innerHeight, 10, 10000 );
        camera.position.set(200, 100, 250);
        scene.add( camera );

		controls = new THREE.TrackballControls( camera, renderer.domElement );
		controls.maxDistance = 800;

		stats = new Stats();
		stats.domElement.style.position = 'absolute';
		stats.domElement.style.top = '0px';
		stats.domElement.style.zIndex = 100;
		document.body.appendChild( stats.domElement );

		projector = new THREE.Projector();

		document.addEventListener( 'mousemove', onDocumentMouseMove, false );
		document.addEventListener( 'keydown', onKeyDown, false );
    }

    function animate() {
        requestAnimationFrame( animate );
        render();
		stats.update();
    }

    function render() {
		controls.update( clock.getDelta() );
        renderer.render( scene, camera );

		var tim = clock.elapsedTime;
		if (!mouseMove && !playingDemo && guiConfig.cameraMoving) {
			camera.position.x += -1 * Math.cos( tim * 0.15);
			camera.position.z += -1 * Math.sin( tim * 0.15);
		} else if ( playingDemo) {
			if (typeof whichApp === 'function') {
				whichApp();
			} else {
				whichApp;  // slow speed
			}
		}
		mouseMove = false;
    }

	function onDocumentMouseMove( event ) { // needs work
		var vector = new THREE.Vector3( ( event.clientX / window.innerWidth ) * 2 - 1, - ( event.clientY / window.innerHeight ) * 2 + 1, 0.5 );
		projector.unprojectVector( vector, camera );
		var ray = new THREE.Ray( camera.position, vector.subSelf( camera.position ).normalize() ),
			intersects = ray.intersectObjects( scans.children );
		if ( intersects.length > 0 ) {
			if ( guiConfig.highlighting && intersected !== intersects[ 0 ].object ) {
				if ( intersected ) { intersected.material.opacity = guiConfig.opacityDefault; }
				intersected = intersects[ 0 ].object;
				scans.current = scans.children.indexOf(intersected);
				brainApp.scanHighlight(scans.current);
			}
		} else {
			if (intersected) { intersected.material.opacity = guiConfig.opacityDefault; }
			intersected = null;
		}
		mouseMove = true;
	}

	function onDocumentMouseClick( event ) {
		// splash.style.display = 'none';
		return;
	}

	function onKeyDown ( event ) {
// http://www.webonweboff.com/tips/js/event_key_codes.aspx
		switch( event.keyCode ) {
			case 37: /*<*/	scans.current--; if (scans.current < 0) {scans.current = hack.count;} brainApp.scanHighlight(scans.current); break;
			case 39: /*>*/	scans.current++; if (scans.current > hack.count) {scans.current = 0;} brainApp.scanHighlight(scans.current); break;
			case 38: /*^*/	scans.current = 0; brainApp.scanHighlight(0); break;
			case 40: /*v*/	scans.current = hack.count; brainApp.scanHighlight(hack.count - 1); break;
		}
	}

	var brainDemo = brainDemo || {};
	brainDemo.currentApp = '';
	brainDemo.i = 20;
	brainDemo.object = '';
	brainDemo.status = document.getElementById('status');

	brainDemo.showSplash = function() {
		splash.style.display = 'block';
	};

	brainDemo.hideSplash = function() {
		splash.style.display = 'none';
		replay_is_on = false;
		audioElement.pause();
	};
	// brainDemo.hideSplash();

	brainDemo.splashBrain = function() {
		if ( brainDemo.currentApp !== 'splashBrain' ) {
			brainDemo.currentApp = 'splashBrain';
			brainDemo.i = 0.1;
			brainDemo.status.innerHTML = 'Here we go...';
		}
		scans.rotation.y += brainDemo.i;
		if (Math.abs(scans.rotation.y) > 4) { brainDemo.i = - brainDemo.i;  }
	};

	brainDemo.theo = function() {
		if ( brainDemo.currentApp !== 'theo' ) {
			brainDemo.i = 50;
			brainDemo.currentApp = 'theo';
			brainDemo.object = document.createElement( 'div' );
			document.body.appendChild( brainDemo.object );
			brainDemo.object.style.top = '20%';
			brainDemo.object.style.position = 'absolute';
			brainDemo.object.innerHTML = '<img src="theo-logo.png" width=200>';
			brainDemo.status.innerHTML = 'See theoarmour.com';
		}
		var stats = document.getElementById('status');
		brainDemo.object.style.left = 250 + 5 * brainDemo.i + 'px';
		brainDemo.object.style.top = 5 * brainDemo.i + 'px';
		if (brainDemo.i > window.innerHeight - 100 ) {brainDemo.i = 50;}
		brainDemo.i++;
	};

	brainDemo.richard = function() {
		if ( brainDemo.currentApp !== 'richard' ) {
			brainDemo.currentApp = 'richard';
			if (brainDemo.object) {
				brainDemo.object.style.display = 'none';
			}
			var i,
				l = hack.count;
			for ( i = 0; i < l; i++ ) {
				scans.children[i].visible = false;
			}
			geometry = new THREE.PlaneGeometry( 200, 100 );
			brainDemo.object = new THREE.Object3D();
			material = createText('Richard', 60, '', '','','','#ff0000'  );
			mesh = new THREE.Mesh( geometry, material );
			mesh.position.set(50, 0, 0);
			brainDemo.object.add( mesh );
			scene.add( brainDemo.object );
			brainDemo.status.innerHTML = 'Eventually we will have a 3D view of Richard to wrap around this brain';
		}
	};

	brainDemo.showScans = function() {
		if ( brainDemo.currentApp !== 'showScans' ) {
			brainDemo.currentApp = 'showScans';
			// brainDemo.i = 20;
			if (brainDemo.object) {
				scene.remove(brainDemo.object);
			}
			geometry = new THREE.CubeGeometry( 100, 100, 100 );
			brainDemo.object = new THREE.Object3D();
			var i, l = hack.count;
			for ( i = 1; i <= l; i++) {
				map = THREE.ImageUtils.loadTexture( hack.dir + i + '.png' );
				material = new THREE.MeshBasicMaterial( { color: 0xffffff, ambient: 0xffffffff, map: map, opacity: 1, side: THREE.DoubleSide, transparent: true, wireframe: false} );
				mesh = new THREE.Mesh( geometry, material );
				mesh.rotation.set(1.57 * Math.random(), 1.57 * Math.random(), 1.57 * Math.random());
				mesh.position.set(200 * Math.random() - 100, 200 * Math.random() + hack.startY - 50, 200 * Math.random() - 100 );
				brainDemo.object.add( mesh );
			}
			scene.add( brainDemo.object );
			brainDemo.status.innerHTML = 'The name of the beast is an oligodendroglioma.' +
			'<br>It\'s home is in my posterior cingulate gyrus, ' +
			'more precisely Brodmanns Area 23.' ;
		}
		var rot = brainDemo.object.rotation;
		rot.set( rot.x += 0.01, rot.y += 0.01, rot.z += 0.01);
	};

	brainDemo.rotateBrain = function() {
		if ( brainDemo.currentApp !== 'rotateBrain' ) {
			brainDemo.currentApp = 'rotateBrain';
			brainDemo.i = 0.02;
			if (brainDemo.object) {
				scene.remove(brainDemo.object);
			}
			var i, l = hack.count;
			for ( i = 0; i < l; i++ ) {
				scans.children[i].visible = true;
			}
			scans.rotation.y = 0;
			brainDemo.status.innerHTML = 'You put your left brain in,' +
			'<br>and you shake it all about...';
		}
		scans.rotation.y += brainDemo.i;
		if (Math.abs(scans.rotation.y) > 0.5) { brainDemo.i = - brainDemo.i;  }
	};

	brainDemo.zoomBrain = function() {
		if ( brainDemo.currentApp !== 'zoomBrain' ) {
			brainDemo.currentApp = 'zoomBrain';
			brainDemo.i = 0.02;
			if (brainDemo.object) {

				scene.remove(brainDemo.object);
			}
		}
// scaling looks just like zooming and is a lot easier to do...
		var scale = scans.scale;
		scale.set( scale.x += brainDemo.i,
			scale.y += brainDemo.i,
			scale.z += brainDemo.i
		);
		if ( scale.x > 1.5  || scale.x < 0.5) { brainDemo.i = - brainDemo.i; }
	};

	brainDemo.panBrain = function() {
		if ( brainDemo.currentApp !== 'panBrain' ) {
			brainDemo.currentApp = 'panBrain';
			brainDemo.i = 1;
			brainDemo.status.innerHTML = 'Press the \'h\' key to hide the controls.';
		}
// moving looks just like panning and is a lot easier to do...
		scans.position.z += brainDemo.i;
		if (Math.abs(scans.position.z) > 50) { brainDemo.i = - brainDemo.i; }
	};

	brainDemo.highlightId = function(id, color) {
		if ( brainDemo.currentApp !== 'highlightId' ) {
			brainDemo.currentApp = 'highlightId';
			brainDemo.i = 0;
		}
		var ids = ['h1','h2','h3','c1','c2','c3'],
			it = document.getElementById(ids[id]);
		it.style.backgroundColor = color;
	};

	brainDemo.finish = function() {
		scans.rotation.y = 0;
		scans.scale.x = scans.scale.y = scans.scale.z = 1;
		scans.position.z = 0;
		brainApp.viewHome();
		brainDemo.status.innerHTML = 'Thanks for watching!' +
		'<br>It\'s probably a good thing to reload this web page if you want faster response.';
		return;
	};

	function createText(text, fontSize, width, height, color, backgroundColor, shadowColor, shadowBlur) {
		var canvas = document.createElement("canvas");
		if (width) { canvas.width = width; }
		if (height) { canvas.height = height; }
		var context = canvas.getContext("2d");
		if (backgroundColor) { context.fillStyle = backgroundColor; } else { context.fillStyle = '#ffffff'; }
		context.fillRect( 0, 0, width, height );
		if (color) { context.fillStyle = color; } else { context.fillStyle = '#000000'; }
		context.globalAlpha = 0.8;
		if (shadowColor) {context.shadowColor = shadowColor; }
		if (shadowBlur) { context.shadowBlur = shadowBlur; } else { context.shadowBlur = 10; }
		if (fontSize) { context.font = fontSize + "pt Arial bold"; } else {context.font = "24pt Arial bold"; }
		context.textBaseline = 'top';
		context.fillText(text, 0, 0);
		var map = new THREE.Texture( canvas );
		map.needsUpdate = true;
		return new THREE.MeshBasicMaterial( { map: map, transparent: true } );
	}

	function mouseEvent(element, type, button, cx, cy ) {
		var evt,
		e = {
			bubbles: true, cancelable: (type !== "mousemove"), view: window, detail: 0,
			screenX: 0, screenY: 0, clientX: cx, clientY: cy,
			ctrlKey: false, altKey: false, shiftKey: false, metaKey: false,
			button: button, relatedTarget: undefined
		};
		button = button || 0;
		cx = cx || 0;
		cy = cy || 0;
		evt = document.createEvent("MouseEvents");
		evt.initMouseEvent(type, e.bubbles, e.cancelable, e.view, e.detail,
		e.screenX, e.screenY, e.clientX, e.clientY,
		e.ctrlKey, e.altKey, e.shiftKey, e.metaKey,
		e.button, document.body.parentNode);
		element.dispatchEvent(evt);
		return evt;
	}

	function zoomView( y ) {
		var elm = controls.domElement;
		mouseEvent( elm, "mousedown", 1 );
		mouseEvent( elm, "mousemove", 1, 0, -y );
		mouseEvent( elm, "mouseup", 1 );
	}

	function rotateView(y) {
		var elm = controls.domElement, wiw = 0.5 * window.innerWidth, wih = 0.5 * window.innerHeight;
		mouseEvent(elm, "mousedown", 0, wiw, wih);
		mouseEvent(elm, "mousemove", 0, wiw - y, wih);
		mouseEvent(elm, "mouseup");
	}

	function panView( x, y ) {
		var elm = controls.domElement,  wiw = 0.5 * window.innerWidth, wih = 0.5 * window.innerHeight;
		mouseEvent( elm, "mousedown", 2, wiw, wih );
		mouseEvent( elm, "mousemove", 2, wiw + x, wih - y );
		mouseEvent( elm, "mouseup", 2);
	}
</script>
</body>
</html>