<!doctype html>
<html lang="en">
<head>
<title>brain of richard</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<script src='http://mrdoob.github.com/three.js/build/three.min.js'></script>
<script src='http://mrdoob.github.com/three.js/examples/js/Stats.js'></script>
<script src="http://mrdoob.github.com/three.js/examples/js/Detector.js"></script>
<script src="http://dat-gui.googlecode.com/git/build/dat.gui.min.js"></script>
<!--
<script src='../../three.js/build/three.min.js'></script>
<script src='../../three.js/examples/js/Detector.js'></script>
<script src='../../three.js/examples/js/Stats.js'></script>
<script src='../../examples/js/DAT.GUI.min.js'></script>
-->

<script src="dat.gui.config.js"></script>
</head>
<body>
<script>
	if ( ! Detector.webgl ) { Detector.addGetWebGLMessage(); }

	document.body.style.font = '12pt monospace';
	document.body.style.margin = '0';
	document.body.style.overflow = 'hidden';
	document.body.style.textAlign = 'center';

	var info = document.createElement( 'div' );
	document.body.appendChild( info );
	info.style.top = '15px';
	info.style.color = '#000';
	info.style.position = 'absolute';
	info.style.width = '100%';
	info.innerHTML = '<b>brain of richard ~ 2012-01-18<\/b>';

	var splash = document.createElement( 'div' );
	document.body.appendChild( splash );
	splash.style.backgroundColor = '#ddd';
	splash.style.borderRadius = '10px';
	splash.style.boxShadow = '10px 10px 5px #888888';
	splash.style.color = '#000';
	splash.style.left = '80px';
	splash.style.opacity = '0.85';
	splash.style.padding = '15px';
	splash.style.position = 'absolute';
	splash.style.top = '48px';
	splash.style.width = '300px';
	var splashText = '<h2 style="text-align:right;"><a href="#" title="Click to close" onClick="brainDemo.hideSplash()" style="color:#888;text-decoration:none;">[X]<\/a><\/h2>' +
	'<h1>The Brain of Richard App<\/h1>' +
	'<p>3D compilations of hundreds of 2D scanned MRI images<\/p>' +
	'<p>Built by Richard and Theo<\/p>' +
	'<h2>~<\/h2>' +
	'<p>Use your mouse or scroll to update the view</p>' +
	'<h2>~<\/h2>' +
	'<p>Launch the 90 second demo...<\/p>';
	splash.innerHTML = splashText;

	var playingDemo = false;
	var whichApp = function(){ return;};
	
	var audioElement = document.createElement('audio');
	

	var demo = document.createElement( 'div' );
	document.body.appendChild( demo );
	demo.style.backgroundColor = '#ddd';
	demo.style.borderRadius = '10px';
	demo.style.boxShadow = '10px 10px 5px #888888';
	demo.style.color = '#000';
	demo.style.display = 'none';
	demo.style.right = '300px';
	demo.style.opacity = '0.85';
	demo.style.padding = '0 15px 15px 15px';
	demo.style.position = 'absolute';
	demo.style.font = 'bold 16pt monospace';
	demo.style.textAlign = 'left';
	demo.style.top = '48px';
	demo.style.width = '300px';
	var demoText = '<h3 style="text-align:right;"><a href="#" title="Click to close" onClick="demo.style.display = \'none\'" style="color:#888;text-decoration:none;">[X]<\/a><\/h3>';
	
	splash.appendChild( audioElement );
	audioElement.setAttribute('src', 'brain-of-richard.ogg');
	audioElement.controls = 'true';

	audioElement.addEventListener("click", function() {
		if ( playingDemo ) {playingDemo = false;}
		demo.style.display = 'none';
	}, false);

	audioElement.addEventListener("playing", function() {
		playingDemo = true;
		demo.style.display = 'block';
	}, false);

	audioElement.addEventListener("timeupdate", function() {
		var duration = document.getElementById('duration'),
			s = parseInt(audioElement.currentTime % 60, 10),
			m = parseInt((audioElement.currentTime / 60) % 60, 10),
			tim = + audioElement.currentTime.toFixed(),
			text;
		if ( tim === 0) {
			text = 'Welcome to the Brain of Richard demo!' +
			'<br><br>With your mouse on screen...' +
			'<br><br>or by clicking on right-side menu...';	
		} else if (tim === 8 ) {
			text = 'You can zoom in and out.';
			whichApp = brainDemo.zoomBrain;	
		} else if (tim === 11 ) {
			text = 'You can rotate the scans.';
			whichApp = brainDemo.rotateBrain;
		} else if (tim === 14 ) {
			text = 'You can pan the camera left and right or up and down.';
			whichApp = brainDemo.panBrain;
		} else if (tim === 19 ) {
			whichApp = function(){ return; };
			text = 'The \'Open Files\' menu lets you open different set of scan files'
			brainDemo.openMenu(guiFiles, guiView);
		} else if (tim === 24 ) {
			whichApp = function(){ return; };
			text = 'The file named \'Right_side_of_brain\' is of particular interest.'
		} else if (tim === 28) {
			text = 'The \'Views\' menu enables you to jump to different views...';
			brainDemo.openMenu(guiViews,guiFiles);
		} else if (tim === 30 ) {
			text = 'including top view...';
			guiConfig.top_view();
		} else if (tim === 34 ) {
			text = 'and side view...';
			guiConfig.side_view();
		} else if (tim === 38 ) {
			text = 'And return to home view' +
			'<br><br>Use this menu if you ever get lost in space...';
			guiConfig.home_view();
		} else if (tim === 42 ) {
			text = 'The \'Scans\' menu allows you to toggle the highlighting on and off';
			brainDemo.openMenu(guiScans,guiViews);
			whichApp = brainDemo.highlightScans;
		} else if (tim === 47 ) {
			text = 'With highlighting on, individual scans highlight as you move over them.';
		} else if (tim === 52 ) {
			whichApp = function(){ return; };
			guiConfig.highlighting = false;
			playingDemo = false;
			guiConfig.cameraMoving = true;
			text = 'The \'Camera\' menu allows you to toggle the automatic camera motion.'
			brainDemo.openMenu(guiCamera,guiScans);
		} else if (tim === 56) {
			text = 'You can also set camera cutoffs. This allows for views that cut through the scans at oblique angles.'
		} else if (tim === 63) {
			playingDemo = true;
			guiConfig.cameraMoving = false;		
			text = 'The \'Extras\' menu toggles the display of four different viewing aids.'
			brainDemo.openMenu(guiExtras,guiCamera);
		} else if (tim === 65 ) {
			text = 'The display aids are:<ul>' +
			'<li>Ground plane</li>' +
			'<li>Bounding box</li>' +
			'<li>3D axis indicator</li>' +
			'<li>Marker box for highlighting items of interest</li></ul>';
		} else if (tim === 75 ) {
			text = 'The \'Help\' menu reminds you that you can press \'h\' to hide this menu';
			brainDemo.openMenu(guiHelp,guiExtras);
		} else if (tim === 80 ) {
			// whichApp = function(){ return; };
			text = 'You can also display the splash screen from here.';
		} else if (tim === 84 ) {
			text = 'Thanks for watching.' +
		'<br><br>Happy brain examining!';
			brainDemo.openMenu(guiView,guiHelp);
			whichApp = brainDemo.finish;
		} else {

		}
		if (text) { demo.innerHTML = demoText + text; }
	}, false);

	//var updates = document.createElement( 'div' );
	//splash.appendChild( updates );
	//updates.style.font = 'bold 16pt monospace';
	//updates.innerHTML = '<p id="duration"><\/p><p id="status"><\/p>';

	var scene, camera, controls, light, stats, renderer;
	var geometry, map, material, mesh;

	var clock = new THREE.Clock();
	var projector;
	var intersected;
	var mouseMove;

	var scans;
	var plane, boundary, axis, box;

	var hack = {};

	function brainHack(count) {
		if (count === 1) {
			hack = {
				count: 26,
				dir: 'hack01/',
				angle: 1.5708,
				startY: -50,
				startZ: 0,
				deltaY: 5,
				deltaZ: 0,
				opacityDefault: 0.2,
				meshY: -50
			};
		}
		if (count === 2) {
			hack = {
				count: 91,
				dir: 'hack02/',
				angle: 0,
				startY: 0,
				startZ: 0,
				deltaY: 0,
				deltaZ: -1,
				opacityDefault: 0.02,
				meshY: -100
			};
		}
		if (count === 3) {
			hack = {
				count: 123,
				dir: 'hack03/',
				angle: 0,
				startY: 0,
				startZ: 0,
				deltaY: 0,
				deltaZ: -1,
				opacityDefault: 0.02,
				meshY: -100
			};
		}	
		if (count === 4 ) {
			hack = {
				count: 194,
				dir: 'plants/artichoke/png/',
				angle: 0,
				startY: 0,
				startZ: 0,
				deltaY: 0,
				deltaZ: -1,
				opacityDefault: 0.2,
				meshY: -100
			};	
		}
		if (count === 5 ) {
			hack = {
				count: 53,
				dir: 'plants/cactus/png/',
				angle: 0,
				startY: 0,
				startZ: 0,
				deltaY: 0,
				deltaZ: -1,
				opacityDefault: 0.1,
				meshY: -100
			};	
		}		
		if ( count > 1 ) {
			guiConfig.cameraMoving = false;
			guiConfig.highlighting = false;
		}
		guiConfig.opacityDefault = hack.opacityDefault;
		guiConfig.scansFinish = hack.count;
		brainApp.buildBrain();
		buildGui();
	}

	var brainApp = brainApp || {};

	brainApp.buildBrain = function() {
		if ( scans ) { scene.remove(scans); }
		geometry = new THREE.PlaneGeometry( 200, 200, 10, 10 );
		scans = new THREE.Object3D();
		scans.current = 0;
		var i, l = hack.count;
		for (i = 1; i <= l; i++) {
			map = THREE.ImageUtils.loadTexture( hack.dir + i + '.png' );
			material = new THREE.MeshBasicMaterial( { color: 0xffffff, ambient: 0xffffffff, map: map, opacity: hack.opacityDefault, side: THREE.DoubleSide, transparent: true, wireframe: false} );
			mesh = new THREE.Mesh( geometry, material );
			mesh.rotation.x = hack.angle;
			mesh.position.set(0, hack.startY + i * hack.deltaY, hack.startZ + i * hack.deltaZ);
			scans.add( mesh );
		}
		scene.add( scans );
	};

	brainApp.scanHighlight = function(count) {
		var i;
		for (i = guiConfig.scansStart - 1, l = hack.count; i < l; i++) {
			scans.children[i].material.opacity = guiConfig.opacityDefault;
			if (i === count) { scans.children[i].material.opacity = guiConfig.opacityHighlight; }
		}
	};

	init();
	brainHack(1);
	animate();

    function init() {

        renderer = new THREE.WebGLRenderer( {antialias: true } );
        renderer.setSize( window.innerWidth, window.innerHeight );
        document.body.appendChild( renderer.domElement );

        scene = new THREE.Scene();

        camera = new THREE.PerspectiveCamera( 40, window.innerWidth / window.innerHeight, 10, 10000 );
        camera.position.set(200, 100, 250);
        scene.add( camera );

		controls = new THREE.TrackballControls( camera, renderer.domElement );
		controls.maxDistance = 800;

		stats = new Stats();
		stats.domElement.style.position = 'absolute';
		stats.domElement.style.top = '0px';
		stats.domElement.style.zIndex = 100;
		document.body.appendChild( stats.domElement );

		projector = new THREE.Projector();

		document.addEventListener( 'mousemove', onDocumentMouseMove, false );
		document.addEventListener( 'keydown', onKeyDown, false );
    }

    function animate() {
        requestAnimationFrame( animate );
        render();
		stats.update();
    }

    function render() {
		controls.update( clock.getDelta() );
        renderer.render( scene, camera );

		var tim = clock.elapsedTime;
		if (!mouseMove && !playingDemo && guiConfig.cameraMoving) {
		// if (!mouseMove && guiConfig.cameraMoving) {
			camera.position.x += -1 * Math.cos( tim * 0.15);
			camera.position.z += -1 * Math.sin( tim * 0.15);	
		} else if ( playingDemo) {
			if (typeof whichApp === 'function') {
				whichApp();
			} else {
				whichApp;  // slow speed
			}	
		}
		mouseMove = false;
    }

	function onDocumentMouseMove( event ) { // needs work
		var vector = new THREE.Vector3( ( event.clientX / window.innerWidth ) * 2 - 1, - ( event.clientY / window.innerHeight ) * 2 + 1, 0.5 );
		projector.unprojectVector( vector, camera );
		var ray = new THREE.Ray( camera.position, vector.subSelf( camera.position ).normalize() ),
			intersects = ray.intersectObjects( scans.children );
		if ( intersects.length > 0 ) {
			if ( guiConfig.highlighting && intersected !== intersects[ 0 ].object ) {
				if ( intersected ) { intersected.material.opacity = guiConfig.opacityDefault; }
				intersected = intersects[ 0 ].object;
				scans.current = scans.children.indexOf(intersected);
				brainApp.scanHighlight(scans.current);
			}
		} else {
			if (intersected) { intersected.material.opacity = guiConfig.opacityDefault; }
			intersected = null;
		}
		mouseMove = true;
	}

	function onDocumentMouseClick( event ) {
		// splash.style.display = 'none';
		return;
	}

	function onKeyDown ( event ) {
// http://www.webonweboff.com/tips/js/event_key_codes.aspx
		switch( event.keyCode ) {
			case 37: /*<*/	scans.current--; if (scans.current < 0) {scans.current = hack.count;} brainApp.scanHighlight(scans.current); break;
			case 39: /*>*/	scans.current++; if (scans.current > hack.count) {scans.current = 0;} brainApp.scanHighlight(scans.current); break;
			case 38: /*^*/	scans.current = 0; brainApp.scanHighlight(0); break;
			case 40: /*v*/	scans.current = hack.count; brainApp.scanHighlight(hack.count - 1); break;
		}
	}

	var brainDemo = brainDemo || {};
	brainDemo.currentApp = '';
	brainDemo.i = 0;
	brainDemo.delta = 0;
	brainDemo.object = '';
	brainDemo.status = document.getElementById('status');

/*
	// about takes care of this...
	brainDemo.showSplash = function() {
		splash.style.display = 'block';
	};

	brainDemo.hideSplash = function() {
		splash.style.display = 'none';
		replay_is_on = false;
		audioElement.pause();
	};
	// brainDemo.hideSplash();
	
*/
	
/*
	brainDemo.theo = function() {
		if ( brainDemo.currentApp !== 'theo' ) {
			brainDemo.i = 50;
			brainDemo.currentApp = 'theo';
			brainDemo.object = document.createElement( 'div' );
			document.body.appendChild( brainDemo.object );
			brainDemo.object.style.top = '20%';
			brainDemo.object.style.position = 'absolute';
			brainDemo.object.innerHTML = '<img src="theo-logo.png" width=200>';
			brainDemo.status.innerHTML = 'See theoarmour.com';
		}
		var stats = document.getElementById('status');
		brainDemo.object.style.left = 250 + 5 * brainDemo.i + 'px';
		brainDemo.object.style.top = 5 * brainDemo.i + 'px';
		if (brainDemo.i > window.innerHeight - 100 ) {brainDemo.i = 50;}
		brainDemo.i++;
	};

	brainDemo.richard = function() {
		if ( brainDemo.currentApp !== 'richard' ) {
			brainDemo.currentApp = 'richard';
			if (brainDemo.object) {
				brainDemo.object.style.display = 'none';
			}
			var i,
				l = hack.count;
			for ( i = 0; i < l; i++ ) {
				scans.children[i].visible = false;
			}
			geometry = new THREE.PlaneGeometry( 200, 100 );
			brainDemo.object = new THREE.Object3D();
			material = createText('Richard', 60, '', '','','','#ff0000'  );
			mesh = new THREE.Mesh( geometry, material );
			mesh.position.set(50, 0, 0);
			brainDemo.object.add( mesh );
			scene.add( brainDemo.object );
			brainDemo.status.innerHTML = 'Eventually we will have a 3D view of Richard to wrap around this brain';
		}
	};
*/

	brainDemo.showScans = function() {
		if ( brainDemo.currentApp !== 'showScans' ) {
			brainDemo.currentApp = 'showScans';
			// brainDemo.i = 20;
			if (brainDemo.object) {
				scene.remove(brainDemo.object);
			}
			geometry = new THREE.CubeGeometry( 100, 100, 100 );
			brainDemo.object = new THREE.Object3D();
			var i, l = hack.count;
			for ( i = 1; i <= l; i++) {
				map = THREE.ImageUtils.loadTexture( hack.dir + i + '.png' );
				material = new THREE.MeshBasicMaterial( { color: 0xffffff, ambient: 0xffffffff, map: map, opacity: 1, side: THREE.DoubleSide, transparent: true, wireframe: false} );
				mesh = new THREE.Mesh( geometry, material );
				mesh.rotation.set(1.57 * Math.random(), 1.57 * Math.random(), 1.57 * Math.random());
				mesh.position.set(200 * Math.random() - 100, 200 * Math.random() + hack.startY - 50, 200 * Math.random() - 100 );
				brainDemo.object.add( mesh );
			}
			scene.add( brainDemo.object );
			brainDemo.status.innerHTML = 'The name of the beast is an oligodendroglioma.' +
			'<br>It\'s home is in my posterior cingulate gyrus, ' +
			'more precisely Brodmanns Area 23.' ;
		}
		var rot = brainDemo.object.rotation;
		rot.set( rot.x += 0.01, rot.y += 0.01, rot.z += 0.01);
	};

	brainDemo.zoomBrain = function() {
		if ( brainDemo.currentApp !== 'zoomBrain' ) {
			brainDemo.currentApp = 'zoomBrain';
			if (brainDemo.object) {
				scene.remove(brainDemo.object);
			}
			brainDemo.i = 0;
			brainDemo.delta = 1;
			guiConfig.highlighting = false;
		}
		zoomView(brainDemo.i);
		if (Math.abs(brainDemo.i) > 20) { brainDemo.delta = - brainDemo.delta;  }
		brainDemo.i += brainDemo.delta; 
	};
	
	brainDemo.rotateBrain = function() {
		if ( brainDemo.currentApp !== 'rotateBrain' ) {
			brainDemo.currentApp = 'rotateBrain';
			if (brainDemo.object) {
				scene.remove(brainDemo.object);
			}			
			brainDemo.i = 0;
			brainDemo.delta = -1;
			guiConfig.highlighting = false;
		}
		rotateView(brainDemo.i);
		if (Math.abs(brainDemo.i) > 20) { brainDemo.delta = - brainDemo.delta;  }
		brainDemo.i += brainDemo.delta; 
	};
	
	brainDemo.panBrain = function() {
		if ( brainDemo.currentApp !== 'panBrain' ) {
			brainDemo.currentApp = 'panBrain';
			brainDemo.i = 0;
			brainDemo.delta = 1;
			guiConfig.highlighting = false;

		}
		panView(brainDemo.i, 0);
		if (Math.abs(brainDemo.i) > 20) { brainDemo.delta = - brainDemo.delta;  }
		brainDemo.i += brainDemo.delta; 
	};

	brainDemo.highlightScans = function(id, color) {
		if ( brainDemo.currentApp !== 'highlightId' ) {
			brainDemo.currentApp = 'highlightId';
			brainDemo.i = 0;
			brainDemo.delta = 1;
		}
		brainApp.scanHighlight(brainDemo.i);
		if (Math.abs(brainDemo.i) > 25) { brainDemo.delta = - brainDemo.delta;  }
		brainDemo.i += brainDemo.delta; 
	};
	
	brainDemo.openMenu  = function(menuOpen, menuClose) {
		if (menuClose) { menuClose.close(); }
		menuOpen.open();
	}
	
	brainDemo.finish = function() {
		scans.rotation.y = 0;
		scans.scale.x = scans.scale.y = scans.scale.z = 1;
		scans.position.z = 0;
		guiConfig.home_view();
		guiConfig.highlighting = true;
		whichApp = function(){ return; };
		return;
	};

	function createText(text, fontSize, width, height, color, backgroundColor, shadowColor, shadowBlur) {
		var canvas = document.createElement("canvas");
		if (width) { canvas.width = width; }
		if (height) { canvas.height = height; }
		var context = canvas.getContext("2d");
		if (backgroundColor) { context.fillStyle = backgroundColor; } else { context.fillStyle = '#ffffff'; }
		context.fillRect( 0, 0, width, height );
		if (color) { context.fillStyle = color; } else { context.fillStyle = '#000000'; }
		context.globalAlpha = 0.8;
		if (shadowColor) {context.shadowColor = shadowColor; }
		if (shadowBlur) { context.shadowBlur = shadowBlur; } else { context.shadowBlur = 10; }
		if (fontSize) { context.font = fontSize + "pt Arial bold"; } else {context.font = "24pt Arial bold"; }
		context.textBaseline = 'top';
		context.fillText(text, 0, 0);
		var map = new THREE.Texture( canvas );
		map.needsUpdate = true;
		return new THREE.MeshBasicMaterial( { map: map, transparent: true } );
	}

	function mouseEvent(element, type, button, cx, cy ) {
		var evt,
		e = {
			bubbles: true, cancelable: (type !== "mousemove"), view: window, detail: 0,
			screenX: 0, screenY: 0, clientX: cx, clientY: cy,
			ctrlKey: false, altKey: false, shiftKey: false, metaKey: false,
			button: button, relatedTarget: undefined
		};
		button = button || 0;
		cx = cx || 0;
		cy = cy || 0;
		evt = document.createEvent("MouseEvents");
		evt.initMouseEvent(type, e.bubbles, e.cancelable, e.view, e.detail,
		e.screenX, e.screenY, e.clientX, e.clientY,
		e.ctrlKey, e.altKey, e.shiftKey, e.metaKey,
		e.button, document.body.parentNode);
		element.dispatchEvent(evt);
		return evt;
	}

	function zoomView( y ) {
		var elm = controls.domElement;
		mouseEvent( elm, "mousedown", 1 );
		mouseEvent( elm, "mousemove", 1, 0, -y );
		mouseEvent( elm, "mouseup", 1 );
	}

	function rotateView( y ) {
		var elm = controls.domElement, wiw = 0.5 * window.innerWidth, wih = 0.5 * window.innerHeight;
		mouseEvent(elm, "mousedown", 0, wiw, wih);
		mouseEvent(elm, "mousemove", 0, wiw - y, wih);
		mouseEvent(elm, "mouseup");
	}

	function panView( x, y ) {
		var elm = controls.domElement,  wiw = 0.5 * window.innerWidth, wih = 0.5 * window.innerHeight;
		mouseEvent( elm, "mousedown", 2, wiw, wih );
		mouseEvent( elm, "mousemove", 2, wiw + x, wih - y );
		mouseEvent( elm, "mouseup", 2);
	}
</script>
</body>
</html>